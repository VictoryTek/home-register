name: Weekly Security Audit

on:
  schedule:
    - cron: "0 8 * * 1" # Monday 8am UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@a54c7afa936fefeb4456b2dd8068152669aa8203 # master
        with:
          toolchain: stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@5b7c79c7e5e993d24a00de2b0f0e76c7648031b0 # v2.49.15
        with:
          tool: cargo-audit

      - name: Run cargo audit
        run: cargo audit --json > rust-audit.json || true

      - name: Run cargo deny advisories
        uses: EmbarkStudios/cargo-deny-action@34899fc7ba81ca6268d5947a7a16b4649013fea1 # v2.0.11
        with:
          command: check advisories

      - name: Generate Rust audit report
        run: |
          echo "# Rust Security Audit Report" > rust-audit-report.md
          echo "Generated: $(date -u)" >> rust-audit-report.md
          echo "" >> rust-audit-report.md
          echo "## cargo audit" >> rust-audit-report.md
          echo '```json' >> rust-audit-report.md
          cat rust-audit.json >> rust-audit-report.md
          echo '```' >> rust-audit-report.md

      - name: Upload Rust audit report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: rust-audit-report
          path: rust-audit-report.md
          retention-days: 30

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > npm-audit.json || true

      - name: Generate NPM audit report
        run: |
          echo "# NPM Security Audit Report" > npm-audit-report.md
          echo "Generated: $(date -u)" >> npm-audit-report.md
          echo "" >> npm-audit-report.md
          echo "## npm audit" >> npm-audit-report.md
          echo '```json' >> npm-audit-report.md
          cat npm-audit.json >> npm-audit-report.md
          echo '```' >> npm-audit-report.md

      - name: Upload NPM audit report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: npm-audit-report
          path: frontend/npm-audit-report.md
          retention-days: 30

  dependency-updates:
    name: Dependency Update Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@a54c7afa936fefeb4456b2dd8068152669aa8203 # master
        with:
          toolchain: stable

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Check Rust outdated dependencies
        run: |
          cargo install cargo-outdated || true
          cargo outdated --format json > rust-outdated.json || true

      - name: Check NPM outdated dependencies
        working-directory: frontend
        run: npm outdated --json > npm-outdated.json || true

      - name: Generate dependency update report
        run: |
          echo "# Dependency Update Report" > dependency-report.md
          echo "Generated: $(date -u)" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Rust Dependencies" >> dependency-report.md
          echo '```json' >> dependency-report.md
          cat rust-outdated.json >> dependency-report.md || echo "{}" >> dependency-report.md
          echo '```' >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## NPM Dependencies" >> dependency-report.md
          echo '```json' >> dependency-report.md
          cat frontend/npm-outdated.json >> dependency-report.md || echo "{}" >> dependency-report.md
          echo '```' >> dependency-report.md

      - name: Upload dependency report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dependency-update-report
          path: dependency-report.md
          retention-days: 30
